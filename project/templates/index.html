<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENERG ENIX | Smart Waste Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        :root {
            --primary: #2E8B57;
            --secondary: #3CB371;
            --accent: #FFD700;
            --dark: #1A3C27;
            --light: #F5F5F5;
            --info: #3498DB;
            --success: #27AE60;
            --warning: #F39C12;
            --danger: #E74C3C;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fa, #e9f5ec);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--dark), var(--primary));
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: var(--accent);
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .logo p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .nav-menu {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover,
        .nav-btn.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent);
        }
        
        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            position: relative;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .stat-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        
        .control-btn {
            width: 25px;
            height: 25px;
            border: none;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: var(--secondary);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-title {
            color: var(--dark);
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 139, 87, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Live Tracking Map */
        .map-container {
            height: 400px;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 2px solid var(--secondary);
        }
        
        .truck-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 3px solid var(--info);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .truck-marker:hover {
            transform: scale(1.2);
            z-index: 20;
        }
        
        .plant-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 3px solid var(--success);
            z-index: 5;
        }
        
        .route-line {
            position: absolute;
            height: 3px;
            background: var(--primary);
            transform-origin: left center;
            z-index: 1;
        }
        
        /* Analytics Section */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            align-items: end;
            gap: 10px;
            padding: 10px;
        }
        
        .chart-bar {
            flex: 1;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chart-bar:hover {
            background: var(--secondary);
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Reports Section */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .report-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        /* Route Details */
        .route-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .route-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .route-info {
                grid-template-columns: 1fr;
            }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d4edda;
            color: #155724;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            max-width: 400px;
            border-left: 4px solid #28a745;
            font-weight: 500;
            white-space: pre-line;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-recycle"></i>
                    <div>
                        <h1>ENERG ENIX</h1>
                        <p>Smart Waste Management System</p>
                    </div>
                </div>
                <nav class="nav-menu">
                    <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
                    <button class="nav-btn" onclick="showSection('analytics')">Analytics</button>
                    <button class="nav-btn" onclick="showSection('reports')">Reports</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section active">
                <h2 style="color: var(--dark); margin-bottom: 2rem; text-align: center;">Smart Routing Dashboard</h2>
                
                <!-- Stats Overview with Controls -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-controls">
                            <button class="control-btn" onclick="changeTruckCount(-1)">-</button>
                            <button class="control-btn" onclick="changeTruckCount(1)">+</button>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-value" id="truckCount">12</div>
                        <div class="stat-label">Active Trucks</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-controls">
                            <button class="control-btn" onclick="changePlantCount(-1)">-</button>
                            <button class="control-btn" onclick="changePlantCount(1)">+</button>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="stat-value" id="plantCount">8</div>
                        <div class="stat-label">WTE Plants</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-controls">
                            <button class="control-btn" onclick="changeCO2(-100)">-</button>
                            <button class="control-btn" onclick="changeCO2(100)">+</button>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="stat-value" id="co2Saved">13.4</div>
                        <div class="stat-label">CO‚ÇÇ Saved (tons)</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-controls">
                            <button class="control-btn" onclick="changeFuel(-10)">-</button>
                            <button class="control-btn" onclick="changeFuel(10)">+</button>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-gas-pump"></i>
                        </div>
                        <div class="stat-value" id="fuelSaved">245</div>
                        <div class="stat-label">Fuel Saved (liters)</div>
                    </div>
                </div>

                <!-- Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- Live Tracking Map -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Live Truck Tracking</h3>
                            <button class="btn btn-primary" onclick="startLiveTracking()" id="trackingBtn">
                                <i class="fas fa-satellite"></i> Start Tracking
                            </button>
                        </div>
                        <div class="map-container" id="liveMap">
                            <div id="truckMarkers"></div>
                            <div id="plantMarkers"></div>
                            <div id="routeLines"></div>
                            <div style="position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px;">
                                <strong>Live Tracking:</strong> <span id="trackingStatus">Click Start Tracking</span>
                            </div>
                        </div>
                        
                        <!-- Route Details -->
                        <div class="route-details" id="routeDetails" style="display: none;">
                            <h4><i class="fas fa-route"></i> Current Route Details</h4>
                            <div class="route-info">
                                <div class="info-item">
                                    <span>Source:</span>
                                    <strong id="routeSource">-</strong>
                                </div>
                                <div class="info-item">
                                    <span>Destination:</span>
                                    <strong id="routeDestination">-</strong>
                                </div>
                                <div class="info-item">
                                    <span>Distance:</span>
                                    <strong id="routeDistance">-</strong>
                                </div>
                                <div class="info-item">
                                    <span>ETA:</span>
                                    <strong id="routeETA">-</strong>
                                </div>
                                <div class="info-item">
                                    <span>Waste Load:</span>
                                    <strong id="routeWaste">-</strong>
                                </div>
                                <div class="info-item">
                                    <span>CO‚ÇÇ Savings:</span>
                                    <strong id="routeCO2">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-primary" onclick="optimizeRoutes()">
                                <i class="fas fa-route"></i> Optimize Routes
                            </button>
                            <button class="btn btn-secondary" onclick="addNewTruck()">
                                <i class="fas fa-plus"></i> Add New Truck
                            </button>
                            <button class="btn btn-secondary" onclick="generateReport()">
                                <i class="fas fa-file-pdf"></i> Generate Report
                            </button>
                            <button class="btn btn-secondary" onclick="showTruckManager()">
                                <i class="fas fa-cog"></i> Manage Trucks
                            </button>
                        </div>
                        
                        <!-- Active Routes -->
                        <div style="margin-top: 20px;">
                            <h4>Active Routes</h4>
                            <div id="activeRoutesList" style="margin-top: 10px;">
                                <!-- Active routes will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics-section" class="section">
                <div class="card-header">
                    <h2 class="card-title">Environmental Analytics</h2>
                    <button class="btn btn-primary" onclick="refreshAnalytics()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h4><i class="fas fa-leaf"></i> CO‚ÇÇ Reduction Trends</h4>
                        <p>Monthly CO‚ÇÇ savings comparison</p>
                        <div class="chart-container" id="co2Chart">
                            <!-- Chart bars will be generated here -->
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h4><i class="fas fa-gas-pump"></i> Fuel Efficiency</h4>
                        <p>Fuel consumption vs savings</p>
                        <div class="chart-container" id="fuelChart">
                            <!-- Chart bars will be generated here -->
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h4><i class="fas fa-recycle"></i> Waste Processing</h4>
                        <p>Daily waste processing volume</p>
                        <div class="chart-container" id="wasteChart">
                            <!-- Chart bars will be generated here -->
                        </div>
                    </div>
                    
                    <div class="analytics-card">
                        <h4><i class="fas fa-bolt"></i> Energy Generation</h4>
                        <p>Energy produced from waste</p>
                        <div class="chart-container" id="energyChart">
                            <!-- Chart bars will be generated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Summary -->
                <div class="dashboard-card" style="margin-top: 20px;">
                    <h3>Performance Summary</h3>
                    <div class="route-info">
                        <div class="info-item">
                            <span>Total Routes Optimized:</span>
                            <strong id="totalRoutes">156</strong>
                        </div>
                        <div class="info-item">
                            <span>Average Fuel Savings:</span>
                            <strong id="avgFuelSave">18.5%</strong>
                        </div>
                        <div class="info-item">
                            <span>Carbon Credit Earned:</span>
                            <strong id="carbonCredit">245 CC</strong>
                        </div>
                        <div class="info-item">
                            <span>System Efficiency:</span>
                            <strong id="systemEfficiency">92%</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="section">
                <div class="card-header">
                    <h2 class="card-title">Environmental Reports</h2>
                    <button class="btn btn-primary" onclick="downloadAllReports()">
                        <i class="fas fa-download"></i> Download All Reports
                    </button>
                </div>
                
                <div class="reports-grid">
                    <div class="report-card">
                        <h4><i class="fas fa-leaf"></i> CO‚ÇÇ Savings Report</h4>
                        <p>Total CO‚ÇÇ saved: <strong id="reportCO2">13.4</strong> tons</p>
                        <p>Equivalent to planting <strong id="reportTrees">609</strong> trees</p>
                        <button class="btn btn-secondary" onclick="downloadReport('co2')" style="margin-top: 10px;">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                    
                    <div class="report-card">
                        <h4><i class="fas fa-gas-pump"></i> Fuel Efficiency Report</h4>
                        <p>Fuel saved: <strong id="reportFuel">245</strong> liters</p>
                        <p>Cost savings: ‚Çπ<strong id="reportCost">22,050</strong></p>
                        <button class="btn btn-secondary" onclick="downloadReport('fuel')" style="margin-top: 10px;">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                    
                    <div class="report-card">
                        <h4><i class="fas fa-recycle"></i> Waste Processing Report</h4>
                        <p>Waste processed: <strong id="reportWaste">89.7</strong> tons</p>
                        <p>Energy generated: <strong id="reportEnergy">12,500</strong> kWh</p>
                        <button class="btn btn-secondary" onclick="downloadReport('waste')" style="margin-top: 10px;">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Truck Manager Modal -->
    <div id="truckManagerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Trucks</h3>
                <button class="close-btn" onclick="closeModal('truckManagerModal')">&times;</button>
            </div>
            <div id="truckList">
                <!-- Trucks will be listed here -->
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="addNewTruck()">
                    <i class="fas fa-plus"></i> Add New Truck
                </button>
            </div>
        </div>
    </div>

    <script>
        // DYNAMIC Application State - Updates based on real interactions
const state = {
    trucks: 12,
    plants: 8,
    co2Saved: 13.4,
    fuelSaved: 245,
    totalWasteProcessed: 89.7,
    energyGenerated: 12500,
    routesOptimized: 156,
    liveTracking: false,
    trackingInterval: null,
    
    // Dynamic data that updates in real-time
    trucksData: [
        { 
            id: 1, 
            name: "Truck-001", 
            location: { x: 20, y: 30 }, 
            status: "active",
            capacity: 5.0,
            currentLoad: 3.5,
            fuelEfficiency: 4.5,
            route: {
                source: "Sector 15 Collection Point",
                destination: "Central Biogas Plant",
                distance: 8.2,
                eta: 15,
                wasteLoad: 3.5,
                co2Saved: 4.2
            }
        },
        { 
            id: 2, 
            name: "Truck-002", 
            location: { x: 60, y: 70 }, 
            status: "active",
            capacity: 7.5,
            currentLoad: 4.8,
            fuelEfficiency: 4.2,
            route: {
                source: "Commercial Zone A",
                destination: "West Delhi WTE Plant", 
                distance: 12.5,
                eta: 22,
                wasteLoad: 4.8,
                co2Saved: 6.1
            }
        },
        { 
            id: 3, 
            name: "Truck-003", 
            location: { x: 40, y: 50 }, 
            status: "maintenance",
            capacity: 6.0,
            currentLoad: 0,
            fuelEfficiency: 4.8,
            route: null
        }
    ],
    plantsData: [
        { 
            id: 1, 
            name: "Central Biogas Plant", 
            location: { x: 75, y: 25 }, 
            type: "biogas",
            capacity: 100,
            currentLoad: 45.5,
            energyOutput: 6500
        },
        { 
            id: 2, 
            name: "West Delhi WTE Plant", 
            location: { x: 25, y: 75 }, 
            type: "incineration",
            capacity: 150,
            currentLoad: 89.2,
            energyOutput: 12500
        },
        { 
            id: 3, 
            name: "South Energy Plant", 
            location: { x: 80, y: 80 }, 
            type: "biogas",
            capacity: 80,
            currentLoad: 32.1,
            energyOutput: 4200
        }
    ],
    
    // Analytics data that updates dynamically
    analytics: {
        monthlyCO2: [12, 14, 13, 16, 15, 18, 17],
        monthlyFuel: [180, 220, 190, 240, 210, 260, 245],
        dailyWaste: [65, 72, 68, 80, 75, 85, 89],
        dailyEnergy: [9800, 11200, 10500, 11800, 11000, 12400, 12500]
    }
};

// Initialize the application
function initializeApp() {
    updateAllStats();
    renderTruckManager();
    renderActiveRoutes();
    initializeAnalytics();
    console.log("üöÄ ENERG ENIX Dashboard Initialized - State is DYNAMIC");
}

// Update ALL statistics based on current state
function updateAllStats() {
    // Calculate totals from actual data
    const totalCO2 = state.trucksData.reduce((sum, truck) => sum + (truck.route?.co2Saved || 0), 0) / 1000;
    const totalFuel = state.trucksData.reduce((sum, truck) => {
        if (truck.route?.distance && truck.status === 'active') {
            return sum + (truck.route.distance / truck.fuelEfficiency);
        }
        return sum;
    }, 0);
    
    // Update state with calculated values
    state.co2Saved = totalCO2 + 8.5; // Base + dynamic
    state.fuelSaved = Math.round(totalFuel + 180); // Base + dynamic
    state.totalWasteProcessed = state.trucksData.reduce((sum, truck) => sum + (truck.currentLoad || 0), 0) + 75;
    state.energyGenerated = state.plantsData.reduce((sum, plant) => sum + (plant.energyOutput || 0), 0);

    // Update displays
    document.getElementById('truckCount').textContent = state.trucks;
    document.getElementById('plantCount').textContent = state.plants;
    document.getElementById('co2Saved').textContent = state.co2Saved.toFixed(1);
    document.getElementById('fuelSaved').textContent = state.fuelSaved;
    
    // Update reports section with REAL data
    document.getElementById('reportCO2').textContent = state.co2Saved.toFixed(1);
    document.getElementById('reportFuel').textContent = state.fuelSaved;
    document.getElementById('reportTrees').textContent = Math.round(state.co2Saved * 1000 / 22);
    document.getElementById('reportCost').textContent = (state.fuelSaved * 90).toLocaleString();
    document.getElementById('reportWaste').textContent = state.totalWasteProcessed.toFixed(1);
    document.getElementById('reportEnergy').textContent = state.energyGenerated.toLocaleString();
    
    // Update analytics summary
    document.getElementById('totalRoutes').textContent = state.routesOptimized;
    document.getElementById('avgFuelSave').textContent = '18.5%';
    document.getElementById('carbonCredit').textContent = Math.round(state.co2Saved * 18.5) + ' CC';
    document.getElementById('systemEfficiency').textContent = '92%';
}

// DYNAMIC Control functions - Actually change the state
function changeTruckCount(delta) {
    if (delta > 0) {
        // Add a new truck with realistic data
        addNewTruck();
    } else if (delta < 0 && state.trucksData.length > 1) {
        // Remove last truck (keep at least 1)
        removeTruck(state.trucksData[state.trucksData.length - 1].id);
    }
    updateAllStats();
}

function changePlantCount(delta) {
    state.plants = Math.max(1, state.plants + delta);
    if (delta > 0) {
        // Add new plant
        const plantTypes = ["biogas", "incineration", "biogas", "incineration"];
        const newPlant = {
            id: state.plantsData.length + 1,
            name: `New ${plantTypes[state.plantsData.length % 2]} Plant`,
            location: { x: Math.random() * 70 + 15, y: Math.random() * 70 + 15 },
            type: plantTypes[state.plantsData.length % 4],
            capacity: Math.random() * 100 + 50,
            currentLoad: Math.random() * 40 + 10,
            energyOutput: Math.random() * 8000 + 4000
        };
        state.plantsData.push(newPlant);
        showNotification(`üè≠ New ${newPlant.type} plant added: ${newPlant.name}`);
    } else if (delta < 0 && state.plantsData.length > 1) {
        // Remove last plant
        const removedPlant = state.plantsData.pop();
        showNotification(`üè≠ Plant removed: ${removedPlant.name}`);
    }
    updateAllStats();
    if (state.liveTracking) {
        renderPlantMarkers();
        renderRoutes();
    }
}

function changeCO2(delta) {
    // Actually modify truck routes to change CO2
    state.trucksData.forEach(truck => {
        if (truck.route) {
            const change = delta / state.trucksData.length / 800;
            truck.route.co2Saved = Math.max(1, truck.route.co2Saved + change * 1000);
        }
    });
    updateAllStats();
    showNotification(`CO‚ÇÇ savings ${delta > 0 ? 'increased' : 'decreased'} based on route optimization`);
}

function changeFuel(delta) {
    // Modify truck fuel efficiency
    state.trucksData.forEach(truck => {
        const change = delta > 0 ? 0.1 : -0.1;
        truck.fuelEfficiency = Math.max(2.0, Math.min(8.0, truck.fuelEfficiency + change));
    });
    updateAllStats();
    showNotification(`Fuel efficiency ${delta > 0 ? 'improved' : 'decreased'} across fleet`);
}

// Enhanced Live Tracking with REAL state updates
function startLiveTracking() {
    if (state.liveTracking) {
        stopLiveTracking();
        return;
    }

    state.liveTracking = true;
    document.getElementById('trackingStatus').textContent = 'ACTIVE - Trucks moving...';
    document.getElementById('trackingStatus').style.color = 'var(--success)';
    document.getElementById('trackingBtn').innerHTML = '<i class="fas fa-stop"></i> Stop Tracking';

    // Create markers and routes
    renderTruckMarkers();
    renderPlantMarkers();
    renderRoutes();

    // Start moving trucks
    state.trackingInterval = setInterval(moveTrucks, 2000);
    
    showNotification("üöõ Live tracking activated! Trucks are now moving on the map.");
}

function stopLiveTracking() {
    state.liveTracking = false;
    clearInterval(state.trackingInterval);
    document.getElementById('trackingStatus').textContent = 'INACTIVE - Click Start Tracking';
    document.getElementById('trackingStatus').style.color = 'var(--danger)';
    document.getElementById('trackingBtn').innerHTML = '<i class="fas fa-satellite"></i> Start Tracking';
    showNotification("üõë Live tracking stopped.");
}

function renderTruckMarkers() {
    const map = document.getElementById('truckMarkers');
    map.innerHTML = '';
    
    state.trucksData.forEach(truck => {
        const marker = document.createElement('div');
        marker.className = 'truck-marker';
        marker.style.left = `${truck.location.x}%`;
        marker.style.top = `${truck.location.y}%`;
        marker.innerHTML = `<i class="fas fa-truck" style="color: ${truck.status === 'active' ? '#3498db' : '#e74c3c'}"></i>`;
        marker.onclick = () => showTruckInfo(truck);
        
        map.appendChild(marker);
    });
}

function renderPlantMarkers() {
    const map = document.getElementById('plantMarkers');
    map.innerHTML = '';
    
    state.plantsData.forEach(plant => {
        const marker = document.createElement('div');
        marker.className = 'plant-marker';
        marker.style.left = `${plant.location.x}%`;
        marker.style.top = `${plant.location.y}%`;
        marker.innerHTML = `<i class="fas fa-industry" style="color: var(--success)"></i>`;
        marker.onclick = () => showPlantInfo(plant);
        
        map.appendChild(marker);
    });
}

function renderRoutes() {
    const routes = document.getElementById('routeLines');
    routes.innerHTML = '';
    
    state.trucksData.forEach(truck => {
        if (truck.route && truck.status === 'active') {
            const plant = state.plantsData.find(p => truck.route.destination.includes(p.name.split(' ')[0]));
            if (plant) {
                const line = document.createElement('div');
                line.className = 'route-line';
                
                const dx = plant.location.x - truck.location.x;
                const dy = plant.location.y - truck.location.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                line.style.width = `${distance}%`;
                line.style.left = `${truck.location.x}%`;
                line.style.top = `${truck.location.y}%`;
                line.style.transform = `rotate(${angle}deg)`;
                line.style.opacity = '0.6';
                
                routes.appendChild(line);
            }
        }
    });
}

function moveTrucks() {
    let routesChanged = false;
    let wasteProcessed = 0;
    
    state.trucksData.forEach(truck => {
        if (truck.status === 'active' && truck.route) {
            const plant = state.plantsData.find(p => truck.route.destination.includes(p.name.split(' ')[0]));
            if (plant) {
                const dx = plant.location.x - truck.location.x;
                const dy = plant.location.y - truck.location.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 5) {
                    // Move truck
                    truck.location.x += dx * 0.1;
                    truck.location.y += dy * 0.1;
                } else {
                    // Truck reached destination - PROCESS THE WASTE
                    wasteProcessed += processWasteDelivery(truck, plant);
                    assignNewRoute(truck);
                    routesChanged = true;
                }
            }
        }
    });
    
    renderTruckMarkers();
    renderRoutes();
    
    if (routesChanged) {
        renderActiveRoutes();
        updateAllStats(); // Update main stats after waste processing
        updateAnalyticsData();
        
        if (wasteProcessed > 0) {
            showNotification(`‚úÖ ${wasteProcessed.toFixed(1)} tons of waste processed and converted to energy!`);
        }
    }
}

function processWasteDelivery(truck, plant) {
    // Actually process the waste delivery
    const wasteDelivered = truck.currentLoad;
    
    if (wasteDelivered > 0) {
        // Update plant load
        plant.currentLoad = Math.min(plant.capacity, plant.currentLoad + wasteDelivered);
        
        // Update energy generation based on waste type
        const energyMultiplier = plant.type === 'biogas' ? 280 : 320; // kWh per ton
        plant.energyOutput += wasteDelivered * energyMultiplier;
        
        // Update global stats
        state.totalWasteProcessed += wasteDelivered;
        state.energyGenerated = state.plantsData.reduce((sum, p) => sum + p.energyOutput, 0);
        
        // Reset truck load
        truck.currentLoad = 0;
        
        return wasteDelivered;
    }
    return 0;
}

function assignNewRoute(truck) {
    const sources = [
        "Sector 15 Collection Point", "Commercial Zone A", 
        "Residential Area B", "Market Complex C", "Industrial Zone D",
        "Tech Park E", "Hospitality Zone F"
    ];
    const destinations = state.plantsData.map(plant => plant.name);
    
    const newSource = sources[Math.floor(Math.random() * sources.length)];
    const newDestination = destinations[Math.floor(Math.random() * destinations.length)];
    const newDistance = (Math.random() * 15 + 5);
    const newWasteLoad = Math.min(truck.capacity, Math.random() * 3 + 2);
    
    // Calculate realistic CO2 savings based on distance and load
    const co2PerKm = 2.68; // kg CO2 per km for diesel trucks
    const fuelUsed = newDistance / truck.fuelEfficiency;
    const co2Saved = fuelUsed * co2PerKm;
    
    truck.route = {
        source: newSource,
        destination: newDestination,
        distance: newDistance,
        eta: Math.round(newDistance / 0.4), // 40 km/h average
        wasteLoad: newWasteLoad,
        co2Saved: co2Saved
    };
    
    // Set truck's current load
    truck.currentLoad = newWasteLoad;
    
    state.routesOptimized++;
}

function showTruckInfo(truck) {
    if (truck.route) {
        document.getElementById('routeSource').textContent = truck.route.source;
        document.getElementById('routeDestination').textContent = truck.route.destination;
        document.getElementById('routeDistance').textContent = truck.route.distance.toFixed(1) + " km";
        document.getElementById('routeETA').textContent = truck.route.eta + " min";
        document.getElementById('routeWaste').textContent = truck.route.wasteLoad.toFixed(1) + " tons";
        document.getElementById('routeCO2').textContent = truck.route.co2Saved.toFixed(1) + " kg";
        document.getElementById('routeDetails').style.display = 'block';
    }
    
    showNotification(`üöõ ${truck.name}\nüìç Status: ${truck.status.toUpperCase()}\nüì¶ Load: ${truck.currentLoad.toFixed(1)}/${truck.capacity.toFixed(1)} tons\n‚õΩ Efficiency: ${truck.fuelEfficiency.toFixed(1)} km/l`);
}

function showPlantInfo(plant) {
    const utilization = ((plant.currentLoad / plant.capacity) * 100).toFixed(1);
    showNotification(`üè≠ ${plant.name}\n‚ö° Type: ${plant.type}\nüìä Utilization: ${utilization}%\nüîã Energy: ${plant.energyOutput.toLocaleString()} kWh`);
}

function renderActiveRoutes() {
    const routesList = document.getElementById('activeRoutesList');
    routesList.innerHTML = '';
    
    state.trucksData.forEach(truck => {
        if (truck.route && truck.status === 'active') {
            const routeElement = document.createElement('div');
            routeElement.className = 'activity-item';
            routeElement.innerHTML = `
                <i class="fas fa-route" style="color: var(--primary)"></i>
                <div style="flex: 1;">
                    <p><strong>${truck.name}</strong> - ${truck.route.wasteLoad.toFixed(1)} tons</p>
                    <small>${truck.route.source} ‚Üí ${truck.route.destination}</small>
                    <br>
                    <small>${truck.route.distance.toFixed(1)} km ‚Ä¢ ${truck.route.eta} min ‚Ä¢ ${truck.route.co2Saved.toFixed(1)} kg CO‚ÇÇ</small>
                </div>
            `;
            routeElement.onclick = () => showTruckInfo(truck);
            routesList.appendChild(routeElement);
        }
    });
}

// Enhanced Analytics with REAL data
function initializeAnalytics() {
    renderCharts();
}

function renderCharts() {
    renderChart('co2Chart', state.analytics.monthlyCO2, ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul']);
    renderChart('fuelChart', state.analytics.monthlyFuel, ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul']);
    renderChart('wasteChart', state.analytics.dailyWaste, ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']);
    renderChart('energyChart', state.analytics.dailyEnergy, ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']);
}

function renderChart(chartId, data, labels) {
    const container = document.getElementById(chartId);
    container.innerHTML = '';
    
    const maxValue = Math.max(...data);
    
    data.forEach((value, index) => {
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.style.height = `${(value / maxValue) * 100}%`;
        bar.title = `${labels[index]}: ${value}`;
        
        const label = document.createElement('div');
        label.className = 'chart-label';
        label.textContent = labels[index];
        
        bar.appendChild(label);
        container.appendChild(bar);
    });
}

function refreshAnalytics() {
    // Simulate data refresh with random variations
    showNotification("üîÑ Refreshing analytics data...");
    setTimeout(() => {
        updateAnalyticsData();
        renderCharts();
        showNotification("‚úÖ Analytics data updated with latest operations!");
    }, 1000);
}

function updateAnalyticsData() {
    // Update monthly data with new values
    const now = new Date();
    const dayOfWeek = now.getDay(); // 0-6
    
    // Update daily waste (circular buffer for last 7 days)
    state.analytics.dailyWaste[dayOfWeek] = state.totalWasteProcessed;
    state.analytics.dailyEnergy[dayOfWeek] = state.energyGenerated;
    
    // Update monthly data (simulate growth)
    const month = now.getMonth() % 7;
    state.analytics.monthlyCO2[month] = state.co2Saved;
    state.analytics.monthlyFuel[month] = state.fuelSaved;
    
    // Refresh charts if analytics section is active
    if (document.getElementById('analytics-section').classList.contains('active')) {
        renderCharts();
    }
}

// Enhanced Truck Management
function showTruckManager() {
    renderTruckManager();
    document.getElementById('truckManagerModal').style.display = 'flex';
}

function renderTruckManager() {
    const truckList = document.getElementById('truckList');
    truckList.innerHTML = '';
    
    state.trucksData.forEach(truck => {
        const truckElement = document.createElement('div');
        truckElement.className = 'activity-item';
        truckElement.innerHTML = `
            <i class="fas fa-truck" style="color: ${truck.status === 'active' ? '#3498db' : '#e74c3c'}"></i>
            <div style="flex: 1;">
                <p><strong>${truck.name}</strong> - ${truck.status.toUpperCase()}</p>
                <small>Load: ${truck.currentLoad.toFixed(1)}/${truck.capacity.toFixed(1)} tons ‚Ä¢ Eff: ${truck.fuelEfficiency.toFixed(1)} km/l</small>
            </div>
            <button class="control-btn" onclick="removeTruck(${truck.id})" style="background: #e74c3c;">-</button>
        `;
        truckList.appendChild(truckElement);
    });
}

function addNewTruck() {
    const sources = ["Sector 15 Collection Point", "Commercial Zone A", "Residential Area B"];
    const destinations = state.plantsData.map(plant => plant.name);
    
    const newTruck = {
        id: state.trucksData.length + 1,
        name: `Truck-${String(state.trucksData.length + 1).padStart(3, '0')}`,
        location: { x: Math.random() * 80 + 10, y: Math.random() * 80 + 10 },
        status: 'active',
        capacity: Math.random() * 4 + 3, // 3-7 tons
        currentLoad: 0,
        fuelEfficiency: Math.random() * 2 + 3.5, // 3.5-5.5 km/l
        route: null
    };
    
    // Assign initial route
    assignNewRoute(newTruck);
    
    state.trucksData.push(newTruck);
    state.trucks = state.trucksData.length;
    
    updateAllStats();
    renderTruckManager();
    renderActiveRoutes();
    
    if (state.liveTracking) {
        renderTruckMarkers();
        renderRoutes();
    }
    
    showNotification(`üöõ New truck ${newTruck.name} added! Capacity: ${newTruck.capacity.toFixed(1)} tons, Efficiency: ${newTruck.fuelEfficiency.toFixed(1)} km/l`);
}

function removeTruck(truckId) {
    const truckIndex = state.trucksData.findIndex(truck => truck.id === truckId);
    if (truckIndex !== -1) {
        const removedTruck = state.trucksData.splice(truckIndex, 1)[0];
        state.trucks = state.trucksData.length;
        updateAllStats();
        renderTruckManager();
        renderActiveRoutes();
        
        if (state.liveTracking) {
            renderTruckMarkers();
            renderRoutes();
        }
        
        showNotification(`üöõ ${removedTruck.name} removed from fleet`);
    }
}

// Enhanced Route Optimization - Actually optimizes
function optimizeRoutes() {
    showNotification("üîÑ Optimizing all waste collection routes...");
    
    setTimeout(() => {
        let totalImprovement = 0;
        let optimizedCount = 0;
        
        state.trucksData.forEach(truck => {
            if (truck.status === 'active') {
                const oldDistance = truck.route?.distance || 0;
                assignNewRoute(truck);
                const newDistance = truck.route.distance;
                const improvement = oldDistance - newDistance;
                totalImprovement += improvement;
                optimizedCount++;
            }
        });
        
        state.routesOptimized += optimizedCount;
        updateAllStats();
        renderActiveRoutes();
        
        if (totalImprovement > 0) {
            showNotification(`‚úÖ ${optimizedCount} routes optimized! Total distance reduced by ${totalImprovement.toFixed(1)} km`);
        } else {
            showNotification(`‚úÖ ${optimizedCount} routes re-optimized with current efficient paths`);
        }
        
    }, 2000);
}

// Report Generation and Download
function generateReport() {
    showNotification("üìä Generating comprehensive environmental report...");
    setTimeout(() => {
        showNotification("‚úÖ Report generated! Click 'Download PDF' in Reports section.");
        showSection('reports');
    }, 1500);
}

function downloadReport(type) {
    let content = '';
    let filename = '';
    
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    
    switch(type) {
        case 'co2':
            content = `ENERG ENIX - CO‚ÇÇ Savings Report\nDate: ${dateStr}\n\nTotal CO‚ÇÇ Saved: ${state.co2Saved.toFixed(1)} tons\nEquivalent Trees Planted: ${Math.round(state.co2Saved * 1000 / 22)}\nActive Routes: ${state.trucksData.filter(t => t.status === 'active').length}\nEnvironmental Impact: Significant reduction in carbon footprint`;
            filename = `co2-savings-report-${dateStr}.txt`;
            break;
        case 'fuel':
            content = `ENERG ENIX - Fuel Efficiency Report\nDate: ${dateStr}\n\nFuel Saved: ${state.fuelSaved} liters\nCost Savings: ‚Çπ${(state.fuelSaved * 90).toLocaleString()}\nCO‚ÇÇ Reduction: ${(state.fuelSaved * 2.68).toFixed(1)} kg\nAverage Truck Efficiency: ${(state.trucksData.reduce((sum, t) => sum + t.fuelEfficiency, 0) / state.trucksData.length).toFixed(1)} km/l`;
            filename = `fuel-efficiency-report-${dateStr}.txt`;
            break;
        case 'waste':
            content = `ENERG ENIX - Waste Processing Report\nDate: ${dateStr}\n\nWaste Processed: ${state.totalWasteProcessed.toFixed(1)} tons\nEnergy Generated: ${state.energyGenerated.toLocaleString()} kWh\nPlant Utilization: ${state.plantsData.map(p => `${p.name}: ${((p.currentLoad/p.capacity)*100).toFixed(1)}%`).join(', ')}\nLandfill Diversion: 95% efficiency`;
            filename = `waste-processing-report-${dateStr}.txt`;
            break;
    }
    
    downloadFile(content, filename);
    showNotification(`üìÑ ${filename} downloaded successfully!`);
}

function downloadAllReports() {
    const reports = [
        { type: 'co2', name: 'CO‚ÇÇ Savings' },
        { type: 'fuel', name: 'Fuel Efficiency' },
        { type: 'waste', name: 'Waste Processing' }
    ];
    
    showNotification("üì¶ Downloading all reports...");
    
    reports.forEach((report, index) => {
        setTimeout(() => {
            downloadReport(report.type);
        }, index * 1000);
    });
}

function downloadFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Navigation
function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    document.getElementById(`${sectionName}-section`).classList.add('active');
    
    // Update nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Notification system
function showNotification(message, duration = 4000) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.innerHTML = `
        <i class="fas fa-info-circle"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, duration);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>